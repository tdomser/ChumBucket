<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chum Bucket</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="wrap">
    <section class="grid" aria-label="Server quick links">
      <a class="card card--logo" href="#" role="button" tabindex="0" aria-expanded="false" aria-controls="blogSection" onclick="toggleEmbed('blogSection', this); return false;" onkeypress="if(event.key==='Enter' || event.key===' ') { toggleEmbed('blogSection', this); event.preventDefault(); }">
    <div class="media"></div>
    <div class="footer">
      <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M5 4h14a2 2 0 0 1 2 2v11.5a2.5 2.5 0 0 1-2.5 2.5H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2zm2 3v2h10V7H7zm0 4v2h7v-2H7z"/>
      </svg>
      <span class="mono">CHUMBUCKET.NET</span>
    </div>
  </a>

      <!-- Map Card toggles embedded iframe -->
      <div class="card card--store"
           role="button"
           tabindex="0"
           aria-expanded="false"
           aria-controls="mapEmbed"
           onclick="toggleEmbed('mapEmbed', this)"
           onkeypress="if(event.key==='Enter' || event.key===' ') { toggleEmbed('mapEmbed', this); event.preventDefault(); }">
        <div class="media"></div>
        <div class="label">Map</div>
      </div>
      <div id="mapEmbed" class="embed-container from-top">
  <div class="embed-controls" aria-hidden="true">
    <button class="embed-btn fullscreen-btn" aria-label="Enter fullscreen" onclick="toggleFullscreen(this)">⛶ Fullscreen</button>
    <button class="embed-btn close-btn" aria-label="Close panel" onclick="hideEmbeds()">✕ Close</button>
  </div>
  <iframe src="https://map.chumbucket.net" title="Server Map" loading="lazy"></iframe>
</div>


      <a class="card card--discord" href="https://discord.gg/XVVhFHjZ" target="_blank" rel="noopener" aria-label="Join our Discord" onclick="hideEmbeds()">
        <div class="discord">
          <img src="assets/discord.png" alt="Discord Logo" width="128" height="128">
          <div class="discord-stat">
            <div class="big">Join the Discord!</div>
          </div>
        </div>
      </a>

      <!-- Stats Card toggles embedded iframe -->
      <div class="card card--stats"
           role="button"
           tabindex="0"
           aria-expanded="false"
           aria-controls="statsEmbed"
           onclick="toggleEmbed('statsEmbed', this)"
           onkeypress="if(event.key==='Enter' || event.key===' ') { toggleEmbed('statsEmbed', this); event.preventDefault(); }">
        <div class="media"></div>
        <div class="label">Stats</div>
      </div>
      <div id="statsEmbed" class="embed-container from-top">
  <div class="embed-controls" aria-hidden="true">
    <button class="embed-btn fullscreen-btn" aria-label="Enter fullscreen" onclick="toggleFullscreen(this)">⛶ Fullscreen</button>
    <button class="embed-btn close-btn" aria-label="Close panel" onclick="hideEmbeds()">✕ Close</button>
  </div>
  <iframe src="https://stats.chumbucket.net" title="Player Analytics" loading="lazy"></iframe>
</div>


      <div class="card card--join" role="region" aria-label="How to join" onclick="hideEmbeds()">
  <div class="media"></div>
  <div class="label">How To Join</div>
  <form class="join" onsubmit="return false">
    <label>Server Name
      <input type="text" value="ChumBucket SMP" readonly onfocus="this.select()">
    </label>
    <label>Server Address
      <input id="serverAddress" type="text" value="chumbucket.net" readonly onfocus="this.select()">
    </label>
    <button type="button" onclick="navigator.clipboard && navigator.clipboard.writeText(document.getElementById('serverAddress').value)">Copy IP</button>
  </form>
</div>
    </section>
  
<div id="blogSection" class="embed-container open">
  <div class="blog-header">
    <h1>Chum Bucket</h1>
  </div>
  <div class="blog-content">
    <h2>Welcome to the Chum Bucket SMP</h2>
    <p>Here you’ll find the latest news, updates, and stories from our community.</p>
    <p>Stay tuned for events, patch notes, and more!</p>
  </div>
</div>

</main>

  <script>
  async function waitTransition(el){
    return new Promise(res => {
      const handler = (e) => {
        if (e.target === el) { el.removeEventListener('transitionend', handler); res(); }
      };
      el.addEventListener('transitionend', handler);
    });
  }

  async function closeEmbed(el){
    if (!el) return;
    if (!el.classList.contains('open')) return;
    // Start following the collapse before triggering it
    followCollapse(el, 900);
    el.classList.remove('open');
    await waitTransition(el);
  }

  // Follow the expanding panel by scrolling the window as it grows
  function followExpand(el, duration = 900){
    const start = performance.now();
    let rafId;

    const tick = (now) => {
      const t = (now - start) / duration;
      const rect = el.getBoundingClientRect();
      const viewport = window.innerHeight;

      // If the panel's bottom is below the viewport, scroll just enough to keep it in view
      const margin = 16; // a little breathing room
      const overflow = rect.bottom - (viewport - margin);
      if (overflow > 0){
        // instant nudge to avoid fighting smooth scrolling and keep in perfect sync
        window.scrollBy({ top: overflow, left: 0, behavior: 'auto' });
      }

      // keep following until transition is done or panel is no longer open
      if (t < 1 && el.classList.contains('open')){
        rafId = requestAnimationFrame(tick);
      }
    };

    rafId = requestAnimationFrame(tick);
    // stop the loop when the transition ends
    el.addEventListener('transitionend', () => cancelAnimationFrame(rafId), { once: true });
  }

  // Follow the collapsing panel by scrolling the window upward as it shrinks
  function followCollapse(el, duration = 900){
    const start = performance.now();
    let rafId;

    const tick = (now) => {
      const t = (now - start) / duration;
      const rect = el.getBoundingClientRect();
      const viewport = window.innerHeight;

      // As the panel collapses, a gap opens at the bottom of the viewport.
      // Pull the page up to keep the panel's bottom near the viewport bottom.
      const margin = 16; // breathing room
      const gap = (viewport - margin) - rect.bottom;
      if (gap > 0){
        window.scrollBy({ top: -gap, left: 0, behavior: 'auto' });
      }

      if (t < 1 && !el.classList.contains('open')){
        rafId = requestAnimationFrame(tick);
      }
    };

    rafId = requestAnimationFrame(tick);
    el.addEventListener('transitionend', () => cancelAnimationFrame(rafId), { once: true });
  }

  async function openEmbed(el, origin='top'){
    if (!el) return;
    el.classList.remove('from-top','from-bottom');
    el.classList.add(origin === 'bottom' ? 'from-bottom' : 'from-top');
    void el.offsetWidth; // reflow so the origin swap takes effect
    el.classList.add('open');

    // Follow the expansion for the same duration as the CSS transition (900ms in styles.css)
    followExpand(el, 900);

    await waitTransition(el);
  }

  
async function toggleEmbed(id, triggerEl){
    const el = document.getElementById(id);
    const others = Array.from(document.querySelectorAll('.embed-container')).filter(x => x !== el);
    // Close other embeds
    for (const o of others){ await closeEmbed(o); }
    document.querySelectorAll('.card[aria-controls]').forEach(c => c.setAttribute('aria-expanded','false'));

    const wasOpen = el.classList.contains('open');

    if (!wasOpen){
        // Open normally
        await openEmbed(el, 'top');
        if (triggerEl) triggerEl.setAttribute('aria-expanded','true');
    } else {
        // Just close if already open
        await closeEmbed(el);
        if (triggerEl) triggerEl.setAttribute('aria-expanded','false');
    }
}


  function hideEmbeds(){
    if (document.fullscreenElement) { document.exitFullscreen(); }
    document.querySelectorAll('.embed-container').forEach(e => e.classList.remove('open'));
    document.querySelectorAll('.card[aria-controls]').forEach(c => c.setAttribute('aria-expanded','false'));
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }


// Fullscreen toggle for an embed container
function toggleFullscreen(btn){
  const container = btn.closest('.embed-container');
  if (!document.fullscreenElement){
    container.requestFullscreen().catch(err => console.error(err));
  }else{
    document.exitFullscreen();
  }
}

// Update button label based on fullscreen state
document.addEventListener('fullscreenchange', () => {
  const isFS = !!document.fullscreenElement;
  document.querySelectorAll('.fullscreen-btn').forEach(b => {
    b.textContent = isFS ? '⛶ Exit Fullscreen' : '⛶ Fullscreen';
    b.setAttribute('aria-label', isFS ? 'Exit fullscreen' : 'Enter fullscreen');
  });
});

</script>
</body>
</html>
